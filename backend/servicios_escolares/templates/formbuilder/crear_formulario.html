{% extends "layouts/base.html" %}
{% load static %}
{% block title %}Crear o Importar Formulario{% endblock %}
{% block content %}

<style>
/* Contenedor general */
.container {
  max-width: 900px;
  margin-top: 2.5rem;
  margin-bottom: 4rem;
}

/* Switch container */
.switch-container {
  display: flex;
  justify-content: center;
  margin-bottom: 2rem;
  gap: 2rem;
}

/* Botones tipo switch */
.switch-btn {
  cursor: pointer;
  padding: 10px 30px;
  border-radius: 30px;
  background: #e0e0e0;
  color: #19376d;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(25, 55, 109, 0.15);
  transition: background 0.3s, color 0.3s;
  user-select: none;
  flex: 1;
  text-align: center;
  font-size: 1.1rem;
}

.switch-btn.active {
  background: #19376d;
  color: #fff;
  box-shadow: 0 4px 20px rgba(25, 55, 109, 0.4);
}

/* Contenedores de formularios */
.form-section {
  max-width: 700px;
  margin: 0 auto;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(25, 55, 109, 0.1);
  background: #fff;
  padding: 2rem;
  transition: opacity 0.5s ease, transform 0.5s ease;
  position: relative;
}

/* Ocultar con animación */
.form-section.hidden {
  opacity: 0;
  transform: translateY(20px);
  pointer-events: none;
  height: 0;
  overflow: hidden;
  padding: 0;
  margin: 0;
  box-shadow: none;
}

/* Encabezados con iconos */
h2.fw-bold {
  display: flex;
  align-items: center;
  gap: 1rem;
  color: #19376d;
  font-weight: 700;
  margin-bottom: 1.5rem;
}

h2.fw-bold img {
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(25, 55, 109, 0.2);
}

/* Botones animados (usa el CSS que ya tienes para .btn-black, .btn-success, etc.) */

/* Inputs y selects */
.form-control, .form-select, textarea.form-control {
  border-radius: 10px;
  padding: 10px 14px;
  box-shadow: inset 0 1px 4px rgb(0 0 0 / 0.1);
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.form-control:focus, .form-select:focus, textarea.form-control:focus {
  border-color: #18b494;
  box-shadow: 0 0 8px rgba(24, 180, 148, 0.5);
  outline: none;
}

/* Espaciado */
.mb-3 {
  margin-bottom: 1.25rem !important;
}

/* Campos dinámicos */
#campos-container > div {
  margin-bottom: 1rem;
}
</style>

<div class="container">
  <div class="switch-container">
    <div id="switch-importar" class="switch-btn active">Importar Formulario JSON</div>
    <div id="switch-crear" class="switch-btn">Crear Formulario</div>
  </div>

  <!-- Formulario Importar -->
  <section id="form-importar" class="form-section">
    <h2 class="fw-bold">
      <img width="94" height="94" src="https://img.icons8.com/isometric/200/import.png" alt="Importar formulario"/>
      Importar Formulario JSON
    </h2>
    <form method="post" enctype="multipart/form-data" action="{% url 'formbuilder:importar_formulario' %}">
      {% csrf_token %}
      <div class="mb-3">
        <input type="file" name="archivo_json" accept=".json" required class="form-control">
      </div>
      <button type="submit" class="btn btn-primary mt-4 w-100 d-flex align-items-center justify-content-center gap-2">Importar</button>
    </form>
  </section>

  <!-- Formulario Crear -->
  <section id="form-crear" class="form-section hidden">
    <h2 class="fw-bold">
      <img width="94" height="94" src="https://img.icons8.com/3d-fluency/200/create.png" alt="Crear formulario"/>
      Crear Formulario
    </h2>
    <form method="post" id="formularioForm">
      {% csrf_token %}
      <div class="mb-3">
        <label for="nombre" class="form-label">Nombre del formulario</label>
        <input type="text" class="form-control" id="nombre" name="nombre" placeholder="Ej. Convocatoria 2025">
      </div>
      <div class="mb-3">
        <label for="descripcion" class="form-label">Descripción</label>
        <textarea class="form-control" id="descripcion" name="descripcion" rows="2" placeholder="Ej. Convocatoria para el preregistro 2025"></textarea>
      </div>

      <h4>Campos</h4>
      <div id="campos-container"></div>

      <h5 class="mt-4">Agregar Nuevo Campo</h5>
      <div class="row g-2 mb-2">
        <div class="col">
          <input type="text" id="nueva_etiqueta" class="form-control" placeholder="Etiqueta del campo">
        </div>
        <div class="col">
          <select id="nuevo_tipo" class="form-select">
            <option value="text">Texto</option>
            <option value="number">Número</option>
            <option value="email">Email</option>
            <option value="radio">Radio</option>
            <option value="checkbox">Checkbox</option>
          </select>
        </div>
        <div class="col-auto d-flex align-items-center">
          <input type="checkbox" id="nuevo_requerido" class="form-check-input">
          <label for="nuevo_requerido" class="form-check-label ms-1">Campo Requerido</label>
        </div>
        <div class="col" id="opciones_nuevo_campo" style="display: none;">
          <input type="text" id="nuevas_opciones" class="form-control" placeholder="Opciones (separadas por coma)">
        </div>
      </div>
      <button type="button" class="btn btn-black w-100 mb-3" onclick="agregarCampo()">Agregar Campo</button>
      <input type="hidden" name="campos_json" id="campos_json">
      <div class="d-flex justify-content-between">
        <a href="{% url 'formbuilder:lista_formularios' %}" class="btn btn-light">Cancelar</a>
        <button type="submit" class="btn btn-success">Guardar Formulario</button>
      </div>
    </form>
  </section>
</div>

<script>
const switchImportar = document.getElementById('switch-importar');
const switchCrear = document.getElementById('switch-crear');
const formImportar = document.getElementById('form-importar');
const formCrear = document.getElementById('form-crear');

switchImportar.addEventListener('click', () => {
  switchImportar.classList.add('active');
  switchCrear.classList.remove('active');

  formCrear.classList.add('hidden');
  setTimeout(() => formImportar.classList.remove('hidden'), 300);
});

switchCrear.addEventListener('click', () => {
  switchCrear.classList.add('active');
  switchImportar.classList.remove('active');

  formImportar.classList.add('hidden');
  setTimeout(() => formCrear.classList.remove('hidden'), 300);
});

// Mantén aquí tu código JS para agregar campos dinámicos
let campos = [];

document.getElementById('nuevo_tipo').addEventListener('change', function() {
    let tipo = this.value;
    document.getElementById('opciones_nuevo_campo').style.display = 
        (tipo === 'radio' || tipo === 'checkbox') ? 'block' : 'none';
});

function agregarCampo() {
    const etiqueta = document.getElementById('nueva_etiqueta').value.trim();
    const tipo = document.getElementById('nuevo_tipo').value;
    const requerido = document.getElementById('nuevo_requerido').checked;
    const opciones = (tipo === 'radio' || tipo === 'checkbox') ?
        document.getElementById('nuevas_opciones').value.split(',').map(x => x.trim()).filter(x => x) : [];

    if (!etiqueta) {
        alert("La etiqueta no puede estar vacía");
        return;
    }

    campos.push({
        id: 'campo_' + Math.random().toString(36).substr(2, 9),
        label: etiqueta,
        type: tipo,
        required: requerido,
        options: opciones
    });

    document.getElementById('nueva_etiqueta').value = '';
    document.getElementById('nuevo_tipo').value = 'text';
    document.getElementById('nuevo_requerido').checked = false;
    document.getElementById('nuevas_opciones').value = '';
    document.getElementById('opciones_nuevo_campo').style.display = 'none';

    renderCampos();
}

function renderCampos() {
    const container = document.getElementById('campos-container');
    container.innerHTML = '';
    campos.forEach((campo, idx) => {
        let opciones = (campo.options || []).join(', ');
        let requerido = campo.required ? 'checked' : '';
        let tipo = campo.type || 'text';

        container.innerHTML += `
            <div class="bg-light rounded px-3 py-3 mb-3 d-flex align-items-center gap-3 flex-wrap">
                <input type="text" class="form-control flex-grow-1" value="${campo.label.replace(/"/g, '&quot;')}"
                    oninput="actualizarCampo(${idx}, 'label', this.value)" placeholder="Etiqueta del campo">
                
                <select class="form-select flex-grow-1" onchange="actualizarCampo(${idx}, 'type', this.value)">
                    <option value="text" ${tipo === 'text' ? 'selected' : ''}>Texto</option>
                    <option value="number" ${tipo === 'number' ? 'selected' : ''}>Número</option>
                    <option value="email" ${tipo === 'email' ? 'selected' : ''}>Email</option>
                    <option value="radio" ${tipo === 'radio' ? 'selected' : ''}>Radio</option>
                    <option value="checkbox" ${tipo === 'checkbox' ? 'selected' : ''}>Checkbox</option>
                </select>
                
                <div class="form-check d-flex align-items-center me-3">
                    <input class="form-check-input" type="checkbox" id="required_${idx}" ${requerido}
                        onchange="actualizarCampo(${idx}, 'required', this.checked)">
                    <label class="form-check-label ms-1" for="required_${idx}">Requerido</label>
                </div>
                
                ${(tipo === 'radio' || tipo === 'checkbox') ? `
                    <input type="text" class="form-control flex-grow-1" style="max-width:250px"
                        value="${opciones}" placeholder="Opciones (separadas por coma)" 
                        oninput="actualizarOpciones(${idx}, this.value)">
                ` : ''}
                
                <button type="button" class="btn btn-link text-danger p-0" title="Eliminar campo" onclick="eliminarCampo(${idx})">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="red" class="bi bi-trash" viewBox="0 0 16 16">
                      <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5.5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6zm3 .5a.5.5 0 0 1 .5-.5.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6z"/>
                      <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1-1V1h-11v1a1 1 0 0 1-1 1H1v1h14V3h-.5zm-1-1V1h-11v1h11z"/>
                    </svg>
                </button>
            </div>
        `;
    });
    document.getElementById('campos_json').value = JSON.stringify(campos);
}

function actualizarCampo(idx, key, value) {
    if (key === 'required') {
        campos[idx][key] = value;
    } else if (key === 'type') {
        campos[idx][key] = value;
        if (value !== 'radio' && value !== 'checkbox') {
            campos[idx]['options'] = [];
        }
    } else {
        campos[idx][key] = value;
    }
    renderCampos();
}

function actualizarOpciones(idx, value) {
    campos[idx]['options'] = value.split(',').map(x => x.trim()).filter(x => x);
    renderCampos();
}

function eliminarCampo(idx) {
    campos.splice(idx, 1);
    renderCampos();
}
</script>
{% endblock %}
