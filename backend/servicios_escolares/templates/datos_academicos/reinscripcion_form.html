{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Reinscripción de Alumno{% endblock %}

{% block extra_css %}
<style>
    /* Estilos que complementan el glassmorphism del template base */
    .form-section {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-left: 4px solid var(--color-primary);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-radius: 15px;
    }
    
    .form-section h5 {
        color: var(--color-primary);
        margin-bottom: 1rem;
        font-weight: 600;
    }
    
    .required-field {
        color: #dc3545;
    }
    
    .form-control, .form-select {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        backdrop-filter: blur(5px);
    }
    
    .form-control:focus, .form-select:focus {
        background: rgba(255, 255, 255, 0.95);
        border-color: var(--color-primary);
        box-shadow: 0 0 0 0.2rem rgba(27, 57, 106, 0.25);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-main">
    <div class="glass-card">
        <div class="text-center mb-4">
            <h1>
                <i class="fas fa-redo me-2"></i>
                Reinscripción de Alumno
            </h1>
            <p class="text-muted">Complete los datos para procesar la reinscripción</p>
        </div>
        
        <form id="reinscripcionForm" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
            {% csrf_token %}
            <!-- Campo oculto para el ID del alumno seleccionado -->
            <input type="hidden" name="alumno" id="alumnoId" value="">
            
            <!-- Búsqueda de Alumno -->
            <div class="form-section">
                <h5><i class="fas fa-search me-2"></i>Búsqueda de Alumno</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="matricula" class="form-label">
                            Matrícula <span class="required-field">*</span>
                        </label>
                        <input type="text" name="matricula" id="matricula" class="form-control" 
                               placeholder="Ingrese matrícula del alumno" required>
                        <div class="invalid-feedback">Por favor ingrese la matrícula</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button type="button" class="btn btn-outline-primary mt-4" onclick="buscarAlumno()">
                            <i class="fas fa-search me-2"></i>Buscar Alumno
                        </button>
                    </div>
                </div>
                
                <!-- Información del alumno encontrado -->
                <div id="alumnoInfo" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-user me-2"></i>Información del Alumno</h6>
                        <div id="alumnoDetalles"></div>
                    </div>
                </div>
            </div>

            <!-- Datos de Reinscripción -->
            <div class="form-section">
                <h5><i class="fas fa-redo me-2"></i>Datos de Reinscripción</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="periodo_escolar" class="form-label">
                            Período Escolar <span class="required-field">*</span>
                        </label>
                        {{ form_reinscripcion.periodo_escolar }}
                        <div class="invalid-feedback">Por favor seleccione el período escolar</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="semestre" class="form-label">
                            Semestre <span class="required-field">*</span>
                        </label>
                        {{ form_reinscripcion.semestre }}
                        <div class="invalid-feedback">Por favor seleccione el semestre</div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="motivo" class="form-label">
                            Motivo de Reinscripción <span class="required-field">*</span>
                        </label>
                        {{ form_reinscripcion.motivo }}
                        <div class="invalid-feedback">Por favor seleccione el motivo</div>
                        <small class="form-text text-muted">Seleccione el motivo por el cual el alumno requiere reinscripción</small>
                    </div>
                </div>
            </div>

            <!-- Información Adicional (Condicional) -->
            <div class="form-section" id="informacionAdicional" style="display: none;">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Información Adicional Requerida</h5>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="observaciones" class="form-label">
                            Observaciones <span class="required-field">*</span>
                        </label>
                        {{ form_reinscripcion.observaciones }}
                        <div class="invalid-feedback">Por favor proporcione observaciones</div>
                        <small class="form-text text-muted">Proporcione detalles específicos sobre la situación del alumno</small>
                    </div>
                </div>
                
                <!-- Campos específicos para baja temporal -->
                <div id="camposBajaTemporal" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Baja Temporal:</strong> Se requiere documentación adicional para justificar la baja temporal.
                    </div>
                </div>
                
                <!-- Campos específicos para cambio de carrera -->
                <div id="camposCambioCarrera" style="display: none;">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="nueva_carrera" class="form-label">
                                Nueva Carrera <span class="required-field">*</span>
                            </label>
                            {{ form_reinscripcion.nueva_carrera }}
                            <div class="invalid-feedback">Por favor seleccione la nueva carrera</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Documentos -->
            <div class="form-section">
                <h5><i class="fas fa-file-alt me-2"></i>Documentos de Soporte</h5>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="carta_motivos" class="form-label">Carta de Motivos</label>
                        {{ form_reinscripcion.carta_motivos }}
                        <div class="invalid-feedback">Por favor seleccione un archivo válido</div>
                        <small class="form-text text-muted">Adjunte la carta de motivos (PDF, DOC, DOCX, JPG, PNG)</small>
                    </div>
                    <div class="col-md-12 mb-3">
                        <label for="documentos_actualizados" class="form-label">Documentos Actualizados</label>
                        {{ form_reinscripcion.documentos_actualizados }}
                        <div class="invalid-feedback">Por favor seleccione un archivo válido</div>
                        <small class="form-text text-muted">Adjunte los documentos actualizados (PDF, DOC, DOCX, JPG, PNG)</small>
                    </div>
                    <div class="col-md-12 mb-3">
                        <label for="comprobante_pago" class="form-label">Comprobante de Pago</label>
                        {{ form_reinscripcion.comprobante_pago }}
                        <div class="invalid-feedback">Por favor seleccione un archivo válido</div>
                        <small class="form-text text-muted">Adjunte el comprobante de pago (PDF, DOC, DOCX, JPG, PNG)</small>
                    </div>
                </div>
            </div>



            <!-- Botones -->
            <div class="text-center mt-4">
                <button type="button" class="btn btn-secondary me-3" onclick="limpiarFormulario()">
                    <i class="fas fa-eraser me-2"></i>Limpiar
                </button>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save me-2"></i>Procesar Reinscripción
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Confirmación -->
<div class="modal fade" id="confirmacionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Reinscripción Exitosa
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <i class="fas fa-redo text-success" style="font-size: 3rem;"></i>
                </div>
                <h5>¡Reinscripción procesada correctamente!</h5>
                <p class="mb-0">Su folio de reinscripción es: <strong id="folioGenerado"></strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="nuevaReinscripcion()">
                    Nueva Reinscripción
                </button>
                <button type="button" class="btn btn-primary" onclick="verListado()">
                    Ver Listado
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('reinscripcionForm');
    const motivoSelect = document.querySelector('[name="motivo"]');
    const informacionAdicional = document.getElementById('informacionAdicional');
    const camposBajaTemporal = document.getElementById('camposBajaTemporal');
    const camposCambioCarrera = document.getElementById('camposCambioCarrera');
    
    // Manejar cambios en el motivo de reinscripción
    if (motivoSelect) {
        motivoSelect.addEventListener('change', function() {
            const motivo = this.value;
            
            // Ocultar todos los campos adicionales primero
            informacionAdicional.style.display = 'none';
            camposBajaTemporal.style.display = 'none';
            camposCambioCarrera.style.display = 'none';
            
            // Mostrar campos según el motivo seleccionado
            if (motivo && motivo !== '') {
                informacionAdicional.style.display = 'block';
                
                if (motivo === 'baja_temporal') {
                    camposBajaTemporal.style.display = 'block';
                } else if (motivo === 'cambio_carrera') {
                    camposCambioCarrera.style.display = 'block';
                }
            }
        });
    }
    
    // Validación de teléfono
    const telefonoField = document.querySelector('[name="telefono_actualizado"]');
    if (telefonoField) {
        telefonoField.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '');
            if (this.value.length === 10) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else if (this.value.length > 0) {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        });
    }
    
    // Validación de email
    const emailField = document.querySelector('[name="email_actualizado"]');
    if (emailField) {
        emailField.addEventListener('blur', function() {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (this.value && !emailRegex.test(this.value)) {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            } else if (this.value) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });
    }
    
    // Envío del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (form.checkValidity()) {
            enviarReinscripcion();
        } else {
            form.classList.add('was-validated');
        }
    });
});

function enviarReinscripcion() {
    const form = document.getElementById('reinscripcionForm');
    const formData = new FormData(form);
    
    // Mostrar loading
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
    submitBtn.disabled = true;
    
    fetch('{% url "datos_academicos:reinscripcion_nueva" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('folioGenerado').textContent = data.folio;
            const modal = new bootstrap.Modal(document.getElementById('confirmacionModal'));
            modal.show();
            form.reset();
            form.classList.remove('was-validated');
            
            // Ocultar secciones condicionales
            document.getElementById('alumnoInfo').style.display = 'none';
            document.getElementById('informacionAdicional').style.display = 'none';
        } else {
            let errorMsg = 'Por favor, corrija los siguientes errores:\n';
            if (data.errors) {
                for (let field in data.errors) {
                    if (Array.isArray(data.errors[field])) {
                        errorMsg += `- ${data.errors[field].join(', ')}\n`;
                    } else {
                        errorMsg += `- ${data.errors[field]}\n`;
                    }
                }
            }
            alert(errorMsg);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexión. Por favor intente nuevamente.');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function limpiarFormulario() {
    const form = document.getElementById('reinscripcionForm');
    form.reset();
    form.classList.remove('was-validated');
    
    // Limpiar el campo oculto del alumno
    document.getElementById('alumnoId').value = '';
    
    // Limpiar clases de validación
    form.querySelectorAll('.is-valid, .is-invalid').forEach(field => {
        field.classList.remove('is-valid', 'is-invalid');
    });
    
    // Ocultar secciones condicionales
    document.getElementById('alumnoInfo').style.display = 'none';
    document.getElementById('informacionAdicional').style.display = 'none';
    document.getElementById('camposBajaTemporal').style.display = 'none';
    document.getElementById('camposCambioCarrera').style.display = 'none';
}

function nuevaReinscripcion() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('confirmacionModal'));
    modal.hide();
    limpiarFormulario();
}

function verListado() {
    window.location.href = '{% url "datos_academicos:reinscripciones_listar" %}';
}

function buscarAlumno() {
    const matricula = document.getElementById('matricula').value;
    
    if (!matricula) {
        alert('Por favor ingrese una matrícula para buscar');
        return;
    }
    
    // Mostrar loading
    const buscarBtn = document.querySelector('button[onclick="buscarAlumno()"]');
    const originalText = buscarBtn.innerHTML;
    buscarBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Buscando...';
    buscarBtn.disabled = true;
    
    fetch(`/datos_academicos/ajax/buscar-alumno/?matricula=${matricula}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const alumno = data.alumno;
                
                // Guardar el ID del alumno en el campo oculto
                document.getElementById('alumnoId').value = alumno.id;
                
                document.getElementById('alumnoDetalles').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Nombre:</strong> ${alumno.nombre_completo}<br>
                            <strong>Carrera:</strong> ${alumno.carrera}<br>
                            <strong>Semestre:</strong> ${alumno.semestre}
                        </div>
                        <div class="col-md-6">
                            <strong>Estatus:</strong> <span class="badge bg-${alumno.estatus === 'Inscrito' ? 'success' : 'warning'}">${alumno.estatus}</span><br>
                            <strong>Promedio:</strong> ${alumno.promedio}<br>
                            <strong>Créditos:</strong> ${alumno.creditos_aprobados}/${alumno.creditos_totales}
                        </div>
                    </div>
                `;
                document.getElementById('alumnoInfo').style.display = 'block';
            } else {
                alert(data.message || 'No se encontró un alumno con esa matrícula');
                document.getElementById('alumnoInfo').style.display = 'none';
                // Limpiar el campo oculto si no se encuentra el alumno
                document.getElementById('alumnoId').value = '';
            }
        })
        .catch(error => {
            alert('Error al buscar el alumno. Intente nuevamente.');
            console.error('Error:', error);
        })
        .finally(() => {
            buscarBtn.innerHTML = originalText;
            buscarBtn.disabled = false;
        });
}
</script>
{% endblock %}