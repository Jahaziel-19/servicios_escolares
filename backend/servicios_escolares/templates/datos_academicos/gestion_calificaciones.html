{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Gestión de Calificaciones{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <div class="row">
    <!-- Encabezado -->
    <div class="row gy-2 align-items-center mb-3">
      <div class="col-12 col-md-8 d-flex align-items-center gap-3">
        <img src="{% static 'img/icons/calificacion.png' %}" alt="Calificaciones" class="img-fluid" style="max-width: 60px;">
        <div>
          <h1 class="mb-0 fw-bold">Gestión de Calificaciones</h1>
          <p class="text-muted mb-0">Administra calificaciones, visualiza estadísticas y genera reportes del rendimiento académico.</p>
        </div>
      </div>
      <div class="col-12 col-md-4 text-md-end">
        <div class="btn-group">
          <button type="button" class="btn btn-outline-success btn-sm" onclick="generarReporte()">
            <i class="material-symbols-rounded me-1">assessment</i>Reportes
          </button>
          <button type="button" class="btn btn-outline-warning btn-sm" onclick="mostrarImportador()">
            <i class="material-symbols-rounded me-1">upload</i>Importar
          </button>
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportarDatos()">
            <i class="material-symbols-rounded me-1">download</i>Exportar
          </button>
          <button type="button" class="btn btn-outline-info btn-sm" onclick="actualizarDatos()">
            <i class="material-symbols-rounded me-1">refresh</i>Actualizar
          </button>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-header p-2 ps-3">
          <div class="d-flex justify-content-between">
            <div>
              <p class="text-sm mb-0 text-capitalize">Total Calificaciones</p>
              <h4 class="mb-0">{{ total_calificaciones }}</h4>
            </div>
            <div class="icon icon-md icon-shape bg-gradient-primary shadow text-center border-radius-lg">
              <i class="material-symbols-rounded opacity-10">grade</i>
            </div>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-2 ps-3">
          <p class="mb-0 text-sm">
            <span class="text-success font-weight-bolder">+{{ calificaciones_mes|default:0 }} <i class="material-symbols-rounded">trending_up</i></span>
            este mes
          </p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-header p-2 ps-3">
          <div class="d-flex justify-content-between">
            <div>
              <p class="text-sm mb-0 text-capitalize">Calificaciones Aprobadas</p>
              <h4 class="mb-0">{{ calificaciones_aprobadas }}</h4>
            </div>
            <div class="icon icon-md icon-shape bg-gradient-success shadow text-center border-radius-lg">
              <i class="material-symbols-rounded opacity-10">check_circle</i>
            </div>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-2 ps-3">
          <p class="mb-0 text-sm">
            <span class="text-success font-weight-bolder">{{ porcentaje_aprobacion|floatformat:1 }}% <i class="material-symbols-rounded">trending_up</i></span>
            de aprobación
          </p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-header p-2 ps-3">
          <div class="d-flex justify-content-between">
            <div>
              <p class="text-sm mb-0 text-capitalize">Calificaciones Reprobadas</p>
              <h4 class="mb-0">{{ calificaciones_reprobadas }}</h4>
            </div>
            <div class="icon icon-md icon-shape bg-gradient-danger shadow text-center border-radius-lg">
              <i class="material-symbols-rounded opacity-10">cancel</i>
            </div>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-2 ps-3">
          <p class="mb-0 text-sm">
            <span class="text-danger font-weight-bolder">{{ porcentaje_reprobacion|floatformat:1 }}% <i class="material-symbols-rounded">trending_down</i></span>
            de reprobación
          </p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6">
      <div class="card">
        <div class="card-header p-2 ps-3">
          <div class="d-flex justify-content-between">
            <div>
              <p class="text-sm mb-0 text-capitalize">Promedio General</p>
              <h4 class="mb-0">{{ promedio_general|floatformat:2 }}</h4>
            </div>
            <div class="icon icon-md icon-shape bg-gradient-info shadow text-center border-radius-lg">
              <i class="material-symbols-rounded opacity-10">analytics</i>
            </div>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-2 ps-3">
          <p class="mb-0 text-sm">
            <span class="text-info font-weight-bolder">{{ total_creditos|default:0 }} <i class="material-symbols-rounded">star</i></span>
            créditos totales
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficos Principales -->
  <div class="row mt-4">
    <div class="col-lg-8 mb-lg-0 mb-4">
      <div class="card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-lg-6">
              <div class="d-flex flex-column h-100">
                <p class="mb-1 pt-2 text-bold">Calificaciones por Carrera</p>
                <h5 class="font-weight-bolder">Distribución Académica</h5>
                <p class="mb-5">Visualización de calificaciones registradas por carrera</p>
                <div class="d-flex">
                  <button class="btn btn-sm btn-outline-primary me-2" onclick="cambiarTipoGrafico('bar')">Barras</button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="cambiarTipoGrafico('line')">Líneas</button>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="chart">
                <canvas id="chart-calificaciones-carrera" class="chart-canvas" height="170"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header pb-0">
          <h6>Distribución por Rangos</h6>
          <p class="text-sm">
            <span class="font-weight-bold">Calificaciones</span> por nivel de desempeño
          </p>
        </div>
        <div class="card-body p-3">
          <div class="chart">
            <canvas id="chart-rangos-calificaciones" class="chart-canvas" height="300"></canvas>
          </div>
          <div class="mt-3">
            <div class="d-flex justify-content-between">
              <span class="text-sm">Excelente (90-100)</span>
              <span class="text-sm font-weight-bold">{{ rangos_cantidades.0|default:0 }}</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="text-sm">Bueno (80-89)</span>
              <span class="text-sm font-weight-bold">{{ rangos_cantidades.1|default:0 }}</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="text-sm">Regular (70-79)</span>
              <span class="text-sm font-weight-bold">{{ rangos_cantidades.2|default:0 }}</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="text-sm">Reprobado (0-69)</span>
              <span class="text-sm font-weight-bold">{{ rangos_cantidades.3|default:0 }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráfico de Tendencias y Estadísticas Adicionales -->
  <div class="row mt-4">
    <div class="col-lg-8 mb-lg-0 mb-4">
      <div class="card">
        <div class="card-header pb-0">
          <h6>Tendencias por Período Escolar</h6>
          <p class="text-sm">Evolución de calificaciones a lo largo del tiempo</p>
        </div>
        <div class="card-body p-3">
          <div class="chart">
            <canvas id="chart-tendencias-periodo" class="chart-canvas" height="300"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header pb-0">
          <h6>Estadísticas por Acreditación</h6>
        </div>
        <div class="card-body p-3">
          <div class="chart">
            <canvas id="chart-acreditacion" class="chart-canvas" height="200"></canvas>
          </div>
          <div class="mt-3">
            {% for acred in acreditacion_stats %}
            <div class="d-flex justify-content-between mb-2">
              <span class="text-sm">{{ acred.acreditacion }}</span>
              <span class="text-sm font-weight-bold">{{ acred.total }}</span>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tablas de información -->
  <div class="row mt-4">
    <div class="col-lg-8 mb-lg-0 mb-4">
      <div class="card">
        <div class="card-header pb-0 p-3">
          <div class="d-flex justify-content-between">
            <h6 class="mb-0">Materias Más Evaluadas</h6>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="ordenarTabla('calificaciones')">Por Calificaciones</button>
              <button class="btn btn-outline-secondary" onclick="ordenarTabla('promedio')">Por Promedio</button>
            </div>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="table-responsive">
            <table class="table align-items-center mb-0" id="tabla-materias">
              <thead>
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Materia</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Calificaciones</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Promedio</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Aprobación</th>
                </tr>
              </thead>
              <tbody>
                {% for materia in materias_populares %}
                <tr>
                  <td>
                    <div class="d-flex px-2 py-1">
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">{{ materia.materia__nombre }}</h6>
                        <p class="text-xs text-secondary mb-0">{{ materia.materia__clave }}</p>
                      </div>
                    </div>
                  </td>
                  <td>
                    <span class="text-xs font-weight-bold">{{ materia.num_calificaciones }}</span>
                  </td>
                  <td>
                    <span class="text-xs font-weight-bold">{{ materia.promedio|floatformat:2 }}</span>
                  </td>
                  <td>
                    <div class="progress-wrapper w-75 mx-auto">
                      <div class="progress-info">
                        <div class="progress-percentage">
                          <span class="text-xs font-weight-bold">{{ materia.porcentaje_aprobacion|floatformat:1 }}%</span>
                        </div>
                      </div>
                      <div class="progress">
                        <div class="progress-bar bg-gradient-success" role="progressbar" 
                             style="width: {{ materia.porcentaje_aprobacion }}%" 
                             aria-valuenow="{{ materia.porcentaje_aprobacion }}" 
                             aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center">No hay datos disponibles</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header pb-0 p-3">
          <h6 class="mb-0">Acciones Principales</h6>
        </div>
        <div class="card-body p-3">
          <ul class="list-group">
            <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
              <div class="d-flex align-items-center">
                <div class="icon icon-shape icon-sm me-3 bg-gradient-primary shadow text-center">
                  <i class="material-symbols-outlined text-white opacity-10">
                    assignment
                  </i>
                </div>
                
                <div class="d-flex flex-column">
                  <a href="{% url 'datos_academicos:calificacion_list' %}">
                  <h6 class="mb-1 text-dark text-sm">Ver Calificaciones</h6>
                  <span class="text-xs">Lista completa de calificaciones</span>
                </a>
                </div>
                
              </div>
              <div class="d-flex">
                <a href="{% url 'datos_academicos:calificacion_list' %}" class="btn btn-link btn-icon-only btn-rounded btn-sm text-dark icon-move-right my-auto">
                  <i class="ni ni-bold-right" aria-hidden="true">assignment</i>
                </a>
              </div>
            </li>
            <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
              <div class="d-flex align-items-center">
                <div class="icon icon-shape icon-sm me-3 bg-gradient-success shadow text-center">
                  <i class="ni ni-fat-add text-white opacity-10"></i>
                </div>
                <div class="d-flex flex-column">
                  <h6 class="mb-1 text-dark text-sm">Nueva Calificación</h6>
                  <span class="text-xs">Registrar nueva calificación</span>
                </div>
              </div>
              <div class="d-flex">
                <a href="{% url 'datos_academicos:calificacion_create' %}" class="btn btn-link btn-icon-only btn-rounded btn-sm text-dark icon-move-right my-auto">
                  <i class="ni ni-bold-right" aria-hidden="true">assignment_add</i>
                </a>
              </div>
            </li>
            <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
              <div class="d-flex align-items-center">
                <div class="icon icon-shape icon-sm me-3 bg-gradient-info shadow text-center">
                  <i class="ni ni-chart-pie-35 text-white opacity-10"></i>
                </div>
                <div class="d-flex flex-column">
                  <h6 class="mb-1 text-dark text-sm">Reportes</h6>
                  <span class="text-xs">Generar reportes estadísticos</span>
                </div>
              </div>
              <div class="d-flex">
                <button class="btn btn-link btn-icon-only btn-rounded btn-sm text-dark icon-move-right my-auto" onclick="generarReporte()">
                  <i class="ni ni-bold-right" aria-hidden="true"></i>
                </button>
              </div>
            </li>
            <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
              <div class="d-flex align-items-center">
                <div class="icon icon-shape icon-sm me-3 bg-gradient-warning shadow text-center">
                  <i class="ni ni-archive-2 text-white opacity-10"></i>
                </div>
                <div class="d-flex flex-column">
                  <h6 class="mb-1 text-dark text-sm">Importar Datos</h6>
                  <span class="text-xs">Cargar calificaciones masivamente</span>
                </div>
              </div>
              <div class="d-flex">
                <button class="btn btn-link btn-icon-only btn-rounded btn-sm text-dark icon-move-right my-auto" onclick="mostrarImportador()">
                  <i class="ni ni-bold-right" aria-hidden="true"></i>
                </button>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Alertas y Notificaciones -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header pb-0">
          <h6>Alertas y Notificaciones</h6>
        </div>
        <div class="card-body p-3">
          <div class="row">
            <div class="col-md-4">
              <div class="alert alert-warning" role="alert">
                <strong>Atención:</strong> {{ materias_bajo_rendimiento|length }} materia(s) con promedio menor a 7.0
              </div>
            </div>
            <div class="col-md-4">
              <div class="alert alert-info" role="alert">
                <strong>Info:</strong> {{ calificaciones_pendientes|default:0 }} calificación(es) pendiente(s) de registro
              </div>
            </div>
            <div class="col-md-4">
              <div class="alert alert-success" role="alert">
                <strong>Éxito:</strong> {{ materias_excelencia|length }} materia(s) con promedio superior a 9.0
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let chartCarrera, chartRangos, chartTendencias, chartAcreditacion;
    
    // Gráfico de Calificaciones por Carrera
    const ctxCarrera = document.getElementById('chart-calificaciones-carrera').getContext('2d');
    const carrerasData = JSON.parse('{{ carreras_calificaciones|safe }}');
    const cantidadesData = JSON.parse('{{ cantidades_calificaciones|safe }}');
    
    chartCarrera = new Chart(ctxCarrera, {
        type: 'bar',
        data: {
            labels: carrerasData,
            datasets: [{
                label: 'Calificaciones',
                data: cantidadesData,
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(255, 205, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y + ' calificaciones';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Gráfico de Distribución por Rangos
    const ctxRangos = document.getElementById('chart-rangos-calificaciones').getContext('2d');
    const rangosData = JSON.parse('{{ rangos_nombres|safe }}');
    const rangosCantidades = JSON.parse('{{ rangos_cantidades|safe }}');
    
    chartRangos = new Chart(ctxRangos, {
        type: 'doughnut',
        data: {
            labels: rangosData,
            datasets: [{
                data: rangosCantidades,
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(220, 53, 69, 0.8)'
                ],
                borderColor: [
                    'rgba(40, 167, 69, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(220, 53, 69, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });

    // Gráfico de Tendencias por Período
    const ctxTendencias = document.getElementById('chart-tendencias-periodo').getContext('2d');
    const periodosData = JSON.parse('{{ periodos_nombres|safe }}' || '[]');
    const promediosData = JSON.parse('{{ periodos_promedios|safe }}' || '[]');
    
    chartTendencias = new Chart(ctxTendencias, {
        type: 'line',
        data: {
            labels: periodosData,
            datasets: [{
                label: 'Promedio General',
                data: promediosData,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    min: 6,
                    max: 10
                }
            }
        }
    });

    // Gráfico de Acreditación
    const ctxAcreditacion = document.getElementById('chart-acreditacion').getContext('2d');
    const acreditacionLabels = {{ acreditacion_labels|safe }};
    const acreditacionData = {{ acreditacion_data|safe }};
    
    chartAcreditacion = new Chart(ctxAcreditacion, {
        type: 'pie',
        data: {
            labels: acreditacionLabels,
            datasets: [{
                data: acreditacionData,
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(54, 162, 235, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Funciones globales
    window.cambiarTipoGrafico = function(tipo) {
        chartCarrera.config.type = tipo;
        chartCarrera.update();
    };

    window.exportarDatos = function() {
        // Implementar exportación de datos
        alert('Función de exportación en desarrollo');
    };

    window.actualizarDatos = function() {
        // Implementar actualización de datos
        location.reload();
    };

    window.generarReporte = function() {
        // Crear modal para seleccionar tipo de reporte
        const modalHtml = `
            <div class="modal fade" id="reporteModal" tabindex="-1" aria-labelledby="reporteModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="reporteModalLabel">Generar Reporte</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="reporteForm">
                                <div class="mb-3">
                                    <label for="tipoReporte" class="form-label">Tipo de Reporte</label>
                                    <select class="form-select" id="tipoReporte" required>
                                        <option value="">Seleccionar tipo...</option>
                                        <option value="general">Reporte General de Calificaciones</option>
                                        <option value="carrera">Reporte por Carrera</option>
                                        <option value="materia">Reporte por Materia</option>
                                        <option value="periodo">Reporte por Período</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="formato" class="form-label">Formato</label>
                                    <select class="form-select" id="formato" required>
                                        <option value="pdf">PDF</option>
                                        <option value="excel">Excel</option>
                                        <option value="csv">CSV</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-primary" onclick="procesarReporte()">Generar Reporte</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remover modal existente si existe
        const existingModal = document.getElementById('reporteModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Agregar modal al DOM
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('reporteModal'));
        modal.show();
    };

    window.mostrarImportador = function() {
        // Crear modal para importar datos
        const modalHtml = `
            <div class="modal fade" id="importadorModal" tabindex="-1" aria-labelledby="importadorModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="importadorModalLabel">Importar Calificaciones</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <strong>Formato requerido:</strong> El archivo debe ser CSV o Excel con las columnas: 
                                Matrícula, Materia, Calificación, Período
                            </div>
                            <form id="importadorForm" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label for="archivo" class="form-label">Seleccionar Archivo</label>
                                    <input type="file" class="form-control" id="archivo" accept=".csv,.xlsx,.xls" required>
                                    <div class="form-text">Formatos soportados: CSV, Excel (.xlsx, .xls)</div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="validarDatos" checked>
                                        <label class="form-check-label" for="validarDatos">
                                            Validar datos antes de importar
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sobrescribir">
                                        <label class="form-check-label" for="sobrescribir">
                                            Sobrescribir calificaciones existentes
                                        </label>
                                    </div>
                                </div>
                            </form>
                            <div id="previewContainer" class="mt-3" style="display: none;">
                                <h6>Vista previa de datos:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm" id="previewTable">
                                        <thead></thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-info" onclick="previsualizarDatos()">Vista Previa</button>
                            <button type="button" class="btn btn-primary" onclick="procesarImportacion()">Importar Datos</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remover modal existente si existe
        const existingModal = document.getElementById('importadorModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Agregar modal al DOM
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('importadorModal'));
        modal.show();
    };

    window.ordenarTabla = function(criterio) {
        // Implementar ordenamiento de tabla
        console.log('Ordenar por:', criterio);
    };

    // Función para procesar la generación de reportes
    window.procesarReporte = function() {
        const tipoReporte = document.getElementById('tipoReporte').value;
        const formato = document.getElementById('formato').value;
        
        if (!tipoReporte || !formato) {
            alert('Por favor selecciona el tipo de reporte y formato.');
            return;
        }
        
        // Simular generación de reporte
        const modal = bootstrap.Modal.getInstance(document.getElementById('reporteModal'));
        modal.hide();
        
        // Mostrar mensaje de procesamiento
        const toast = `
            <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        Generando reporte ${tipoReporte} en formato ${formato.toUpperCase()}...
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        
        // Crear contenedor de toast si no existe
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.insertAdjacentHTML('beforeend', toast);
        const toastElement = toastContainer.lastElementChild;
        const bsToast = new bootstrap.Toast(toastElement);
        bsToast.show();
        
        // Simular descarga después de 2 segundos
        setTimeout(() => {
            const link = document.createElement('a');
            link.href = '#';
            link.download = `reporte_${tipoReporte}_${new Date().toISOString().split('T')[0]}.${formato}`;
            link.click();
            
            // Mostrar toast de éxito
            const successToast = `
                <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            Reporte generado exitosamente y descargado.
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            toastContainer.insertAdjacentHTML('beforeend', successToast);
            const successToastElement = toastContainer.lastElementChild;
            const bsSuccessToast = new bootstrap.Toast(successToastElement);
            bsSuccessToast.show();
        }, 2000);
    };

    // Función para previsualizar datos de importación
    window.previsualizarDatos = function() {
        const archivo = document.getElementById('archivo').files[0];
        if (!archivo) {
            alert('Por favor selecciona un archivo.');
            return;
        }
        
        // Simular lectura de archivo y mostrar vista previa
        const previewContainer = document.getElementById('previewContainer');
        const previewTable = document.getElementById('previewTable');
        
        // Datos de ejemplo para la vista previa
        const datosEjemplo = [
            ['Matrícula', 'Materia', 'Calificación', 'Período'],
            ['2021001', 'Matemáticas I', '8.5', '2024-1'],
            ['2021002', 'Física I', '9.0', '2024-1'],
            ['2021003', 'Química I', '7.8', '2024-1']
        ];
        
        // Crear tabla de vista previa
        let tableHtml = '<thead><tr>';
        datosEjemplo[0].forEach(header => {
            tableHtml += `<th>${header}</th>`;
        });
        tableHtml += '</tr></thead><tbody>';
        
        for (let i = 1; i < datosEjemplo.length; i++) {
            tableHtml += '<tr>';
            datosEjemplo[i].forEach(cell => {
                tableHtml += `<td>${cell}</td>`;
            });
            tableHtml += '</tr>';
        }
        tableHtml += '</tbody>';
        
        previewTable.innerHTML = tableHtml;
        previewContainer.style.display = 'block';
    };

    // Función para procesar la importación de datos
    window.procesarImportacion = function() {
        const archivo = document.getElementById('archivo').files[0];
        const validarDatos = document.getElementById('validarDatos').checked;
        const sobrescribir = document.getElementById('sobrescribir').checked;
        
        if (!archivo) {
            alert('Por favor selecciona un archivo.');
            return;
        }
        
        // Simular procesamiento de importación
        const modal = bootstrap.Modal.getInstance(document.getElementById('importadorModal'));
        modal.hide();
        
        // Mostrar mensaje de procesamiento
        const toast = `
            <div class="toast align-items-center text-white bg-info border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        Procesando importación de ${archivo.name}...
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        
        // Crear contenedor de toast si no existe
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.insertAdjacentHTML('beforeend', toast);
        const toastElement = toastContainer.lastElementChild;
        const bsToast = new bootstrap.Toast(toastElement);
        bsToast.show();
        
        // Simular finalización después de 3 segundos
        setTimeout(() => {
            const successToast = `
                <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            Importación completada: 3 calificaciones procesadas exitosamente.
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            toastContainer.insertAdjacentHTML('beforeend', successToast);
            const successToastElement = toastContainer.lastElementChild;
            const bsSuccessToast = new bootstrap.Toast(successToastElement);
            bsSuccessToast.show();
            
            // Recargar página para mostrar datos actualizados
            setTimeout(() => {
                location.reload();
            }, 2000);
        }, 3000);
    };
});
</script>
{% endblock %}