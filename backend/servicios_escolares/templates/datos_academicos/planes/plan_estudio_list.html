{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Planes de Estudio{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" type="text/css" href="{% static 'assets/css/datatables.min.css' %}"/>
<style>
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 20px;
        color: white;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    .stats-card:hover {
        transform: translateY(-5px);
    }
    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    .stats-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    .filter-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .table-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .plan-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    .badge-active {
        background-color: #d4edda;
        color: #155724;
    }
    .badge-inactive {
        background-color: #f8d7da;
        color: #721c24;
    }
    .progress-bar {
        height: 8px;
        border-radius: 4px;
        background-color: #e9ecef;
        overflow: hidden;
    }
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s ease;
    }
    .action-buttons {
        display: flex;
        gap: 5px;
    }
    .btn-action {
        padding: 5px 10px;
        border-radius: 5px;
        text-decoration: none;
        font-size: 0.8rem;
        transition: all 0.3s ease;
    }
    .btn-view {
        background-color: #17a2b8;
        color: white;
    }
    .btn-edit {
        background-color: #ffc107;
        color: #212529;
    }
    .btn-view:hover, .btn-edit:hover {
        transform: scale(1.05);
        text-decoration: none;
        color: inherit;
    }
    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                    <div class="bg-gradient-primary shadow-primary border-radius-lg pt-4 pb-3">
                        <div class="d-flex justify-content-between align-items-center px-3">
                            <div>
                                <h6 class="text-white text-capitalize ps-3">Gestión de Planes de Estudio</h6>
                                <p class="text-white text-sm ps-3 mb-0">Administra y visualiza los planes de estudio por carrera</p>
                            </div>
                            <div>
                                <button class="btn btn-outline-white btn-sm me-2" onclick="exportData()">
                                    <i class="material-symbols-rounded text-sm">download</i>&nbsp;&nbsp;Exportar
                                </button>
                                <button class="btn btn-outline-white btn-sm me-2" onclick="refreshData()">
                                    <i class="material-symbols-rounded text-sm">refresh</i>&nbsp;&nbsp;Actualizar
                                </button>
                                <a href="{% url 'datos_academicos:plan_estudio_create' %}" class="btn btn-white btn-sm">
                                    <i class="material-symbols-rounded text-sm">add</i>&nbsp;&nbsp;Nuevo Plan
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-sm-6">
            <div class="card">
                <div class="card-header p-2 ps-3">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="text-sm mb-0 text-capitalize">Total de Planes</p>
                            <h4 class="mb-0">{{ total_planes }}</h4>
                        </div>
                        <div class="icon icon-md icon-shape bg-gradient-dark shadow text-center border-radius-lg">
                            <i class="material-symbols-rounded opacity-10">assignment</i>
                        </div>
                    </div>
                </div>
                <hr class="dark horizontal my-0">
                <div class="card-footer p-2 ps-3">
                    <p class="mb-0 text-sm">
                        <span class="text-success font-weight-bolder">+3% <i class="material-symbols-rounded">trending_up</i></span>
                        desde el mes pasado
                    </p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6">
            <div class="card">
                <div class="card-header p-2 ps-3">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="text-sm mb-0 text-capitalize">Carreras Activas</p>
                            <h4 class="mb-0">{{ total_carreras }}</h4>
                        </div>
                        <div class="icon icon-md icon-shape bg-gradient-primary shadow text-center border-radius-lg">
                            <i class="material-symbols-rounded opacity-10">school</i>
                        </div>
                    </div>
                </div>
                <hr class="dark horizontal my-0">
                <div class="card-footer p-2 ps-3">
                    <p class="mb-0 text-sm">
                        <span class="text-success font-weight-bolder">+5% <i class="material-symbols-rounded">trending_up</i></span>
                        desde el mes pasado
                    </p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6">
            <div class="card">
                <div class="card-header p-2 ps-3">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="text-sm mb-0 text-capitalize">Promedio Materias</p>
                            <h4 class="mb-0">{{ promedio_materias_por_carrera }}</h4>
                        </div>
                        <div class="icon icon-md icon-shape bg-gradient-success shadow text-center border-radius-lg">
                            <i class="material-symbols-rounded opacity-10">menu_book</i>
                        </div>
                    </div>
                </div>
                <hr class="dark horizontal my-0">
                <div class="card-footer p-2 ps-3">
                    <p class="mb-0 text-sm">
                        <span class="text-info font-weight-bolder">{{ promedio_materias_por_carrera }} <i class="material-symbols-rounded">book</i></span>
                        materias por carrera
                    </p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6">
            <div class="card">
                <div class="card-header p-2 ps-3">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="text-sm mb-0 text-capitalize">Años con Planes</p>
                            <h4 class="mb-0">{{ años_disponibles|length }}</h4>
                        </div>
                        <div class="icon icon-md icon-shape bg-gradient-info shadow text-center border-radius-lg">
                            <i class="material-symbols-rounded opacity-10">calendar_today</i>
                        </div>
                    </div>
                </div>
                <hr class="dark horizontal my-0">
                <div class="card-footer p-2 ps-3">
                    <p class="mb-0 text-sm">
                        <span class="text-info font-weight-bolder">{{ años_disponibles|length }} <i class="material-symbols-rounded">event</i></span>
                        años disponibles
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6>Planes por Carrera</h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary active" onclick="toggleChartType('bar')">
                                <i class="material-symbols-rounded text-sm">bar_chart</i>
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="toggleChartType('pie')">
                                <i class="material-symbols-rounded text-sm">pie_chart</i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart">
                        <canvas id="planesCarreraChart" class="chart-canvas" height="170"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header pb-0">
                    <h6>Estadísticas por Carrera</h6>
                    <p class="text-sm">
                        <span class="font-weight-bold">Resumen</span> de planes por carrera
                    </p>
                </div>
                <div class="card-body p-3">
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table align-items-center mb-0">
                            <thead>
                                <tr>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Carrera</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Planes</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Materias</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Créditos</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in stats_por_carrera %}
                                <tr>
                                    <td>
                                        <div class="d-flex px-2 py-1">
                                            <div class="d-flex flex-column justify-content-center">
                                                <h6 class="mb-0 text-sm">{{ stat.carrera|truncatechars:15 }}</h6>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="text-xs font-weight-bold">{{ stat.planes }}</span>
                                    </td>
                                    <td>
                                        <span class="text-xs font-weight-bold">{{ stat.materias }}</span>
                                    </td>
                                    <td>
                                        <span class="text-xs font-weight-bold">{{ stat.creditos }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header pb-0">
                    <h6>Filtros de Búsqueda</h6>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-4">
                            <div class="input-group input-group-outline">
                                <label class="form-label">Buscar por clave, año o carrera...</label>
                                <input type="text" class="form-control" name="q" value="{{ request.GET.q }}">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="input-group input-group-static mb-4">
                                <label for="carrera" class="ms-0">Carrera</label>
                                <select class="form-control" id="carrera" name="carrera">
                                    <option value="">Todas las carreras</option>
                                    {% for carrera in carreras %}
                                    <option value="{{ carrera.id }}" 
                                            {% if request.GET.carrera == carrera.id|stringformat:"s" %}selected{% endif %}>
                                        {{ carrera.nombre }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="input-group input-group-static mb-4">
                                <label for="año" class="ms-0">Año</label>
                                <select class="form-control" id="año" name="año">
                                    <option value="">Todos los años</option>
                                    {% for año in años_disponibles %}
                                    <option value="{{ año }}" 
                                            {% if request.GET.año == año|stringformat:"s" %}selected{% endif %}>
                                        {{ año }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="material-symbols-rounded text-sm">filter_list</i>&nbsp;&nbsp;Filtrar
                            </button>
                            <a href="{% url 'datos_academicos:plan_estudio_list' %}" class="btn btn-outline-secondary">
                                <i class="material-symbols-rounded text-sm">clear</i>
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
                            <i class="fas fa-filter me-1"></i>Filtrar
                        </button>
                        <a href="{% url 'datos_academicos:plan_estudio_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i>
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6>Lista de Planes de Estudio</h6>
                        <span class="badge badge-sm bg-gradient-secondary">{{ page_obj.paginator.count }} planes</span>
                    </div>
                </div>
                <div class="card-body px-0 pb-2">
                    {% if planes %}
                    <div class="table-responsive p-0">
                        <table class="table align-items-center mb-0">
                            <thead>
                                <tr>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Clave</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Año</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Carrera</th>
                                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Materias</th>
                                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Créditos</th>
                                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Progreso</th>
                                    <th class="text-secondary opacity-7"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for plan_data in planes_con_materias %}
                                <tr>
                                    <td>
                                        <div class="d-flex px-2 py-1">
                                            <div class="d-flex flex-column justify-content-center">
                                                <h6 class="mb-0 text-sm">{{ plan_data.plan.clave }}</h6>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <p class="text-xs font-weight-bold mb-0">{{ plan_data.plan.año }}</p>
                                    </td>
                                    <td>
                                        <div class="d-flex px-2 py-1">
                                            <div class="d-flex flex-column justify-content-center">
                                                <h6 class="mb-0 text-sm">{{ plan_data.plan.carrera.nombre|truncatechars:30 }}</h6>
                                                <p class="text-xs text-secondary mb-0">{{ plan_data.plan.carrera.clave }}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="align-middle text-center text-sm">
                                        <span class="badge badge-sm bg-gradient-success">{{ plan_data.materias_count }}</span>
                                    </td>
                                    <td class="align-middle text-center">
                                        <span class="text-secondary text-xs font-weight-bold">{{ plan_data.creditos_totales }}</span>
                                    </td>
                                    <td class="align-middle text-center text-sm">
                                        <div class="progress-wrapper w-75 mx-auto">
                                            <div class="progress-info">
                                                <div class="progress-percentage">
                                                    <span class="text-xs font-weight-bold">
                                                        {% if plan_data.materias_count > 0 %}{{ plan_data.materias_count }}{% else %}0{% endif %}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="progress">
                                                <div class="progress-bar bg-gradient-info w-{% if plan_data.materias_count > 0 %}{{ plan_data.materias_count|floatformat:0 }}{% else %}0{% endif %}" 
                                                     role="progressbar" aria-valuenow="{% if plan_data.materias_count > 0 %}{{ plan_data.materias_count }}{% else %}0{% endif %}" 
                                                     aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="align-middle">
                                        <a href="{% url 'datos_academicos:plan_estudio_detail' plan_data.plan.pk %}" 
                                           class="text-secondary font-weight-bold text-xs me-2" data-toggle="tooltip" data-original-title="Ver detalles">
                                            <i class="material-symbols-rounded text-sm">visibility</i>
                                        </a>
                                        <a href="{% url 'datos_academicos:plan_estudio_edit' plan_data.plan.pk %}" 
                                           class="text-secondary font-weight-bold text-xs" data-toggle="tooltip" data-original-title="Editar">
                                            <i class="material-symbols-rounded text-sm">edit</i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="material-symbols-rounded text-muted" style="font-size: 3rem;">folder_open</i>
                        <p class="text-muted mt-2">No se encontraron planes de estudio</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

                <!-- Pagination -->
                {% if is_paginated %}
                <nav aria-label="Navegación de páginas" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.carrera %}carrera={{ request.GET.carrera }}&{% endif %}{% if request.GET.año %}año={{ request.GET.año }}&{% endif %}page=1">
                                    <i class="fas fa-angle-double-left"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.carrera %}carrera={{ request.GET.carrera }}&{% endif %}{% if request.GET.año %}año={{ request.GET.año }}&{% endif %}page={{ page_obj.previous_page_number }}">
                                    <i class="fas fa-angle-left"></i>
                                </a>
                            </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.carrera %}carrera={{ request.GET.carrera }}&{% endif %}{% if request.GET.año %}año={{ request.GET.año }}&{% endif %}page={{ num }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.carrera %}carrera={{ request.GET.carrera }}&{% endif %}{% if request.GET.año %}año={{ request.GET.año }}&{% endif %}page={{ page_obj.next_page_number }}">
                                    <i class="fas fa-angle-right"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.carrera %}carrera={{ request.GET.carrera }}&{% endif %}{% if request.GET.año %}año={{ request.GET.año }}&{% endif %}page={{ page_obj.paginator.num_pages }}">
                                    <i class="fas fa-angle-double-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

                
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No se encontraron planes de estudio</h5>
                    <p class="text-muted">Intenta ajustar los filtros de búsqueda o 
                        <a href="{% url 'datos_academicos:plan_estudio_create' %}">crear un nuevo plan</a>
                    </p>
                </div>
                
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script src="{% static 'assets/js/plugins/chartjs.min.js' %}"></script>
<script>
// Variables globales para los gráficos
let planesCarreraChart;
let currentChartType = 'bar';

// Datos para los gráficos
const planesCarreraData = {
    labels: [{% for item in planes_por_carrera %}'{{ item.carrera__nombre|truncatechars:20 }}'{% if not forloop.last %},{% endif %}{% endfor %}],
    datasets: [{
        label: 'Planes de Estudio',
        data: [{% for item in planes_por_carrera %}{{ item.total }}{% if not forloop.last %},{% endif %}{% endfor %}],
        backgroundColor: [
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 99, 132, 0.8)',
            'rgba(255, 205, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)',
            'rgba(255, 159, 64, 0.8)',
            'rgba(199, 199, 199, 0.8)',
            'rgba(83, 102, 255, 0.8)'
        ],
        borderColor: [
            'rgba(54, 162, 235, 1)',
            'rgba(255, 99, 132, 1)',
            'rgba(255, 205, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 159, 64, 1)',
            'rgba(199, 199, 199, 1)',
            'rgba(83, 102, 255, 1)'
        ],
        borderWidth: 2
    }]
};

// Configuración del gráfico de barras
const barConfig = {
    type: 'bar',
    data: planesCarreraData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.parsed.y + ' planes de estudio';
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
};

// Configuración del gráfico de pastel
const pieConfig = {
    type: 'pie',
    data: planesCarreraData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                        return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                    }
                }
            }
        }
    }
};

// Inicializar gráficos
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('planesCarreraChart').getContext('2d');
    planesCarreraChart = new Chart(ctx, barConfig);
});

// Función para cambiar tipo de gráfico
function toggleChartType(type) {
    if (currentChartType === type) return;
    
    currentChartType = type;
    planesCarreraChart.destroy();
    
    const ctx = document.getElementById('planesCarreraChart').getContext('2d');
    
    if (type === 'bar') {
        planesCarreraChart = new Chart(ctx, barConfig);
    } else {
        planesCarreraChart = new Chart(ctx, pieConfig);
    }
    
    // Actualizar botones activos
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.closest('button').classList.add('active');
}

// Funciones de utilidad
function exportData() {
    // Implementar exportación de datos
    alert('Función de exportación en desarrollo');
}

function refreshData() {
    location.reload();
}

// Mejorar la experiencia de usuario con tooltips
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar tooltips si Bootstrap está disponible
    if (typeof bootstrap !== 'undefined') {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
});
</script>
{% endblock %}