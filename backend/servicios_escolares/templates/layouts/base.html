{% load static %}
{% load group_filters %}
<!DOCTYPE html>
<html lang="es">

<head>
    {% include "includes/head.html" %}
    <link rel="stylesheet" href="{% static 'servicios_escolares/css/se-ui.css' %}">
    {% block extrastyle %}{% endblock extrastyle %}
    {% block extra_css %}{% endblock extra_css %}
    {% block extrahead %}{% endblock extrahead %}
    <style>
        :root {
            --color-primary: #1B396A;
        }

        /* Contenedor principal centrado */
        .container-main {
            max-width: 1100px;
            margin: 3rem auto;
            padding: 2rem;
        }

        /* Efecto Glassmorphism */
        .glass-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.5),
                inset 0 -1px 0 rgba(255, 255, 255, 0.1),
                inset 0 0 20px 10px rgba(255, 255, 255, 1);
            position: relative;
            overflow: hidden;
            padding: 2rem;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
        }

        .glass-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 1px;
            height: 100%;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.8), transparent, rgba(255, 255, 255, 0.3));
        }

        /* Botones reutilizables */
        .btn-primary {
            background: linear-gradient(135deg, #3182ce, #2c5282);
            border: none;
            color: #fff;
            font-weight: 600;
            padding: 0.6rem 1.2rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(49, 130, 206, 0.5);
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2c5282, #3182ce);
            box-shadow: 0 6px 20px rgba(49, 130, 206, 0.7);
            transform: translateY(-2px);
        }

        /* Tabla moderna */
        .table {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(25, 55, 109, 0.1);
            margin-top: 2rem;
        }

        .table thead {
            background: var(--color-primary);
            color: #fff !important;
            font-weight: 600;
        }

        .table thead th {
            border: none;
            padding: 1rem 1.25rem;
            color: #fff !important;
        }

        .table tbody tr:hover {
            background-color: #e2f6f3;
        }

        .table tbody td {
            vertical-align: middle;
            padding: 1rem 1.25rem;
        }

        /* Encabezado */
        h1 {
            color: var(--color-primary);
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        /* Sidebar responsive animation */
        .sidenav {
            transition: transform .35s ease, width .25s ease, opacity .25s ease;
            will-change: transform, width;
            z-index: 1051; /* por encima del overlay */
        }

        /* Overlay para móvil cuando el sidebar está abierto */
        .sidenav-overlay {
            position: fixed;
            inset: 0;
            background: rgba(16, 24, 40, 0.35);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            display: none;
            z-index: 1040; /* por debajo del sidenav y encima del contenido */
        }

        /* Usamos la semántica de Material Dashboard: body.g-sidenav-show controla estados */
        @media (max-width: 1199.98px) {
            /* Oculto por defecto cuando existe sidenav en layouts móviles/tablet */
            body.g-sidenav-show:not(.g-sidenav-pinned) .sidenav,
            body:not(.g-sidenav-pinned) .sidenav,
            #sidenav-main {
                transform: translate3d(-110%, 0, 0) !important;
                opacity: 0.98;
            }
            /* Visible cuando está fijado */
            body.g-sidenav-show.g-sidenav-pinned .sidenav,
            body.g-sidenav-pinned .sidenav,
            body.g-sidenav-pinned #sidenav-main {
                transform: translate3d(0, 0, 0) !important;
                opacity: 1;
            }

            /* Mostrar overlay solo en móvil cuando abierto */
            body.g-sidenav-show.g-sidenav-pinned .sidenav-overlay,
            body.g-sidenav-pinned .sidenav-overlay { display: block; }

            /* Asegurar que el sidenav no agregue margen en móvil */
            .sidenav { margin-left: 0 !important; }
        }

        /* Respeto a usuarios con movimiento reducido */
        @media (prefers-reduced-motion: reduce) {
            .sidenav { transition: none; }
            .sidenav-overlay { backdrop-filter: none; }
        }

        /* Asegurar empuje del contenido en escritorio cuando el sidenav está presente */
        @media (min-width: 1199.98px) {
            body.g-sidenav-show .sidenav.fixed-start + .main-content {
                margin-left: 14rem; /* coincide con $navbar-vertical-open-width */
            }
        }
    </style>
</head>

<body data-theme="{{ theme_name|default:'publico' }}" class="{% if request.user.is_authenticated %}{% if request.user.is_superuser or request.user|has_group:'ServiciosEscolares' or request.user|has_group:'Servicios Escolares' %}g-sidenav-show {% endif %}{% endif %}bg-gray-100">

    {% block sidebar %}
        {% if request.user.is_authenticated %}
            {% if request.user.is_superuser or request.user|has_group:'ServiciosEscolares' or request.user|has_group:'Servicios Escolares' %}
                {% include "includes/sidebar_material.html" %}
            {% endif %}
        {% endif %}
    {% endblock sidebar %}

    <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">
        
        {% block navigation %}
            {% include "includes/navigation.html" %}
        {% endblock navigation %}

        {% block content %}{% endblock content %}
    </main>

    <!-- Overlay para cerrar el sidebar en móvil (fuera de la adyacencia .sidenav + .main-content) -->
    <div id="sidenav-overlay" class="sidenav-overlay" aria-hidden="true"></div>

    {% include "includes/scripts.html" %}
    {% block extra_js %}{% endblock extra_js %}

</body>

{% include "includes/modal_periodo.html" %}
{% include "includes/success_modal.html" %}
{% include "includes/error_modal.html" %}
{% include "includes/success_auto_modal.html" %}

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Auto mostrar errores desde messages
    {% if messages %}
        {% for message in messages %}
            {% if 'error' in message.tags %}
                showErrorModal("{{ message|escapejs }}");
            {% elif 'success' in message.tags %}
                showSuccessModal("{{ message|escapejs }}");
            {% endif %}
        {% endfor %}
    {% endif %}
});

// Toggle responsive del sidebar y overlay
(function(){
  const body = document.body;
  const overlay = document.getElementById('sidenav-overlay');

  function isMobile(){ return window.innerWidth < 1200; }

  function closeSidenav(){ body.classList.remove('g-sidenav-pinned'); }

  function syncOverlay(){
    if (!overlay) return;
    overlay.style.display = (isMobile() && body.classList.contains('g-sidenav-pinned')) ? 'block' : 'none';
  }

  // Cerrar con tecla Escape en móvil
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape' && isMobile() && body.classList.contains('g-sidenav-pinned')) {
      closeSidenav();
      syncOverlay();
    }
  });

  // Cerrar haciendo clic fuera (overlay)
  overlay && overlay.addEventListener('click', function(){
    closeSidenav();
    syncOverlay();
  });

  // Observar cambios en la clase del body (producidos por el script del tema)
  const observer = new MutationObserver(() => { syncOverlay(); });
  observer.observe(body, { attributes: true, attributeFilter: ['class'] });

  // Responder a cambios de tamaño de ventana
  window.addEventListener('resize', function(){
    // En móvil: iniciar cerrado por defecto
    if (isMobile()) { closeSidenav(); }
    syncOverlay();
  });

  // Estado inicial
  if (isMobile()) { closeSidenav(); }
  syncOverlay();
})();
</script>

</html>
